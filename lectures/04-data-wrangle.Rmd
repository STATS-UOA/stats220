---
title: "STATS 220"
subtitle: "Data wrangling`r emo::ji('hammer_and_wrench')`"
type: "lecture"
date: ""
output:
  xaringan::moon_reader:
    css: ["assets/remark.css"]
    lib_dir: libs
    nature:
      ratio: 16:9
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r initial, echo = FALSE, cache = FALSE, results = 'hide'}
library(knitr)
options(htmltools.dir.version = FALSE, htmltools.preserve.raw = FALSE, 
  tibble.width = 60, tibble.print_min = 6)
opts_chunk$set(
  echo = TRUE, warning = FALSE, message = FALSE, comment = "#>",
  fig.path = 'figure/', cache.path = 'cache/', cache = FALSE, fig.retina = 3,
  fig.align = 'center', fig.width = 12, fig.height = 8.5, fig.show = 'hold',
  dpi = 120
)
```

```{r xaringan-panelset, echo = FALSE}
xaringanExtra::use_panelset()
```

```{r external, include = FALSE, cache = FALSE}
read_chunk('R/04-data-wrangle.R')
```

## Let's talk about code readability again!

* looooooooooooooooong!

```r
show_up_to_work(have_breakfast(glam_up(dress(shower(wake_up("I"))))))
```

* infinite nesting......

```r
show_up_to_work(
  have_breakfast(
    glam_up(
      dress(
        shower(
          wake_up("I")
        )
      )
    )
  )
)
```

---

<br>
.pull-left[
## Does this one look better?

```r
morning1 <- wake_up("I")
morning2 <- shower(morning1)
morning3 <- dress(morning2)
morning4 <- glam_up(morning3)
morning5 <- have_breakfast(morning4)
morning6 <- show_up_to_work(morning5)
```

.x[
* many intermediate steps
* not meaningful variable names
]
]

--

.pull-right[
## How about this one?

```r
morning_routine <- "I" %>% 
  wake_up() %>% 
  shower() %>% 
  dress() %>% 
  glam_up() %>% 
  have_breakfast() %>% 
  show_up_to_work()
```
.checked[
* `%>%` for expressing a **linear** sequence of multiple operations
]
]

---

class: inverse middle center

<img src="https://github.com/rstudio/hex-stickers/raw/master/SVG/pipe.svg" height="420px">

RStudio shortcut: Ctrl/Cmd + Shift + M

---

## Time use in OECD

```{r read-time-use}
```

---

## Pipe the input into the first argument in the function

```{r gg-time-use, fig.height = 2.5, fig.width = 8, echo = FALSE}
```

.pull-left[
```{r ref.label = "gg-time-use", eval = FALSE}
```
]
.pull-right[
```{r gg-time-use-pipe, eval = FALSE}
```
]

---

background-image: url("img/cog-comp.png")
background-size: contain

.footnote[image credit: Hadley Wickham]

---

.left-column[
.center[<img src="https://raw.githubusercontent.com/rstudio/hex-stickers/master/PNG/dplyr.png" width="60%">]
]
.right-column[
{dplyr} is a grammar of data manipulation, providing a consistent set of **verbs** that help you solve the most common data manipulation challenges:

1. .green[`mutate()`] adds new variables that are functions of existing variables
2. .green[`select()`] picks variables based on their names.
3. .green[`filter()`] picks cases based on their values.
4. .green[`summarise()`] reduces multiple values down to a single summary.
5. .green[`arrange()`] changes the ordering of the rows.

These all combine naturally with .green[`group_by()`] which allows you to perform any operation “by group”.
]

???

* rowwise
* colwise
* group-wise

---

class: inverse middle

# One table verbs

---

## Rename columns

```{r rename}
```

---

## Distinct rows

.pull-left[
```{r distinct}
```
]
.pull-right[
```{r distinct2}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `slice()`: subsets rows using their positions
```{r slice}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `group_by()`: group by one or more variables
```{r group-by, highlight.output = 2}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `group_by()`: use in conjunction with other verbs
```{r slice-gb, highlight.output = 2}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `slice()` shortcuts: `slice_head()` & `slice_tail()`
```{r slice-head, highlight.output = 2}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `ungroup()`: removes grouping
```{r ungroup}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `slice_sample()` randomly selects rows
```{r slice-sample}
```
]

???

* random sampling
* bootstrapping

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `arrange()`: arrange rows by columns
```{r arrange}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `arrange()`: arrange rows by columns
```{r arrange-desc}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `arrange()`: arrange rows by columns
```{r arrange-desc2}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `filter()`: subsets rows using columns
```{r filter}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `filter()`: subsets rows using columns
```{r filter-gb}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `filter()`: subsets rows using columns
```{r filter-in}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `filter()`: subsets rows using columns
```{r filter-not}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `filter()`: subsets rows using columns
```{r filter-and, results = "hold", eval = 1}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `filter()`: subsets rows using columns
.center[<img src="https://github.com/allisonhorst/stats-illustrations/raw/master/rstats-artwork/dplyr_filter.jpg" height="520px">]
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `filter()`: subsets rows using columns
```{r filter-or}
```
]

---

## Logical operators

.center[
```{r logical-op}
```
]

.pull-left[
* element-wise comparisons:

```{r logical-op-el}
```
]
.pull-right[
* first-element only comparisons:

```{r logical-op-first}
```
]

---

.left-column[
## Verbs
### - rowwise
]
.right-column[
* `filter()`: subsets rows using columns
```{r filter-anz}
```
```{r filter-anz-line, echo = FALSE, fig.width = 3, fig.height = 3.5}
```
]

---

.left-column[
## Verbs
### - rowwise
### - colwise
]
.right-column[
* `select()`: subsets columns using their names and types
```{r select, eval = 1, results = "hold"}
```
]

---

.left-column[
## Verbs
### - rowwise
### - colwise
]
.right-column[
Selection helpers
  + `starts_with()`: starts with a prefix.
  + `ends_with()`: ends with a suffix.
  + `contains()`: contains a literal string.
  + [more helpers](https://dplyr.tidyverse.org/reference/select.html#overview-of-selection-features)
```{r select-helpers}
```
]

---

.left-column[
## Verbs
### - rowwise
### - colwise
]
.right-column[
* `mutate()`: creates, modifies, and deletes columns
```{r mutate}
```
]

---

.left-column[
## Verbs
### - rowwise
### - colwise
]
.right-column[
* `mutate()`: creates, modifies, and deletes columns
.center[<img src="https://github.com/allisonhorst/stats-illustrations/raw/master/rstats-artwork/dplyr_mutate.png" height="520px">]
]

---

## `case_when()`: when it's the case, do something

.pull-left[
<br>
<br>
.center[<img src="https://github.com/allisonhorst/stats-illustrations/raw/master/rstats-artwork/dplyr_case_when.png" width="100%">]
]
.pull-right[
<br>
<br>
```{r case-when}
```
]

---

.left-column[
## Verbs
### - rowwise
### - colwise
]
.right-column[
* `summarise()`: summarises to one row
```{r summarise}
```
]

---

.left-column[
## Verbs
### - rowwise
### - colwise
]
.right-column[
* `summarise()`: summarises each group to fewer rows
```{r summarise-gb}
```
]

---

## Chain with `%>%`

.pull-left[
```{r ref.label = "filter-anz", eval = FALSE}
```
```{r ref.label = "mutate", eval = FALSE, echo = 1:6}
```
```{r ref.label = "summarise-gb", eval = FALSE}
```
]
.pull-right[
```{r chain, eval = FALSE}
```
]

---

class: middle

## When to `%>%`

.pull-left[
```{r ref.label = "chain", eval = FALSE}
```
]
.pull-right[
1. Linear code dependency structure
2. < 10 steps
3. Inputs and outputs of the same type
   + {dplyr} verbs, tibble in and out
]

---

## Useful shortcuts

```{r shortcuts, results = "hold", eval = 1}
```

---

## Hello again, SQL!

```{r dbplyr-con, cache = FALSE, highlight.output = 1:3}
```

---

## Write {dplyr} code as usual to manipulate database

```{r dbplyr-verbs, cache = FALSE}
```

---

## Speak in SQL from R

.pull-left[
.center[Show SQL queries]
.small[
```{r dbplyr-q, cache = FALSE}
```
]
]
.pull-right[
.center[Retrieve results to R]
.small[
```{r dbplyr-collect, cache = FALSE}
```
]
]

---

class: inverse middle

## Two table verbs

---

## A second data table

.pull-left[
.small[
```{r time-use-2}
```
]
]
.pull-right[
.small[
```{r countrycode}
```
]
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
**Mutating joins:** .brown[add new variables] to one data frame from matching observations in another.
<br>
<br>
<br>
.center[<img src="https://d33wubrfki0l68.cloudfront.net/aeab386461820b029b7e7606ccff1286f623bae1/ef0d4/diagrams/join-venn.png" width="100%">]
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `inner_join()`: All rows from `x` where there are matching values in `y`, and all columns from `x` and `y`

.center[<img src="https://github.com/gadenbuie/tidyexplain/raw/master/images/inner-join.gif" width="50%">]

.footnote[image credit: Garrick Aden-Buie]
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `inner_join()`: All rows from `x` where there are matching values in `y`, and all columns from `x` and `y`

```{r inner-join}
```
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `left_join()`: All rows from `x`, and all columns from `x` and `y`. Rows in `x` with no match in `y` will have `NA` values in the new columns.

.center[<img src="https://github.com/gadenbuie/tidyexplain/raw/master/images/left-join.gif" width="50%">]

.footnote[image credit: Garrick Aden-Buie]
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `left_join()`: All rows from `x`, and all columns from `x` and `y`. Rows in `x` with no match in `y` will have `NA` values in the new columns.
```{r left-join}
```
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `left_join()`: All rows from `x`, and all columns from `x` and `y`. .brown[Rows in `x` with no match in `y` will have `NA` values in the new columns.]
```{r left-join-na}
```
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `right_join()`: All rows from `y`, and all columns from `x` and `y`. Rows in `y` with no match in `x` will have `NA` values in the new columns.
.center[<img src="https://github.com/gadenbuie/tidyexplain/raw/master/images/right-join.gif" width="50%">]

.footnote[image credit: Garrick Aden-Buie]
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `right_join()`: All rows from `y`, and all columns from `x` and `y`. Rows in `y` with no match in `x` will have `NA` values in the new columns.
```{r right-join}
```
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `full_join()`: All rows and all columns from both `x` and `y`. Where there are not matching values, returns `NA` for the one missing.
.center[<img src="https://github.com/gadenbuie/tidyexplain/raw/master/images/full-join.gif" width="50%">]

.footnote[image credit: Garrick Aden-Buie]
]

---

.left-column[
## Joins
### - mutating joins
]
.right-column[
* `full_join()`: All rows and all columns from both `x` and `y`. Where there are not matching values, returns `NA` for the one missing.
```{r full-join}
```
]

---

.left-column[
## Joins
### - mutating joins
### - filtering joins
]
.right-column[
**Filtering joins:** .brown[filter observations] from one data frame based on whether or not they match an observation in the other table.
* `semi_join()`: All rows from `x` where there are matching values in `y`, keeping just columns from `x`.
.center[<img src="https://github.com/gadenbuie/tidyexplain/raw/master/images/semi-join.gif" width="50%">]

.footnote[image credit: Garrick Aden-Buie]
]

---

.left-column[
## Joins
### - mutating joins
### - filtering joins
]
.right-column[
* `semi_join()`: All rows from `x` where there are matching values in `y`, keeping just columns from `x`.
```{r semi-join}
```
]

---

.left-column[
## Joins
### - mutating joins
### - filtering joins
]
.right-column[
* `anti_join()`: All rows from `x` where there are **not** matching values in `y`, keeping just columns from `x`.
.center[<img src="https://github.com/gadenbuie/tidyexplain/raw/master/images/anti-join.gif" width="50%">]

.footnote[image credit: Garrick Aden-Buie]
]

---

.left-column[
## Joins
### - mutating joins
### - filtering joins
]
.right-column[
* `anti_join()`: All rows from `x` where there are **not** matching values in `y`, keeping just columns from `x`.
```{r anti-join}
```
]

---

class: center

## .purple[Upcoming R-Ladies meetup]

[<img src="img/rladies-meetup.png" width="100%">](https://www.meetup.com/en-AU/rladies-auckland/events/276942471)

---

## Reading

.pull-left[
.center[[<img src="https://d33wubrfki0l68.cloudfront.net/b88ef926a004b0fce72b2526b0b5c4413666a4cb/24a30/cover.png" height="520px">](https://r4ds.had.co.nz)]
]
.pull-right[
* [Pipes](https://r4ds.had.co.nz/pipes.html)
* [Data transformation](https://r4ds.had.co.nz/transform.html)
* [Relational data](https://r4ds.had.co.nz/relational-data.html)
* [{dplyr} cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf)
]
